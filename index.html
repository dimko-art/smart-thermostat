<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>Smart Thermostat</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial;
  background: #e6e6e6;
  color: #222;
  margin: 0;
  padding: 30px;
}

.card {
  background: #ffffff;
  max-width: 420px;
  margin: auto;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  text-align: center;
}

input {
  width: 100px;
  padding: 8px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
  text-align: center;
  margin: 6px;
}

button {
  padding: 10px 20px;
  font-size: 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin: 6px;
}

.on { background: #4caf50; color: #fff; }
.off { background: #9e9e9e; color: #fff; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <h2>Smart Thermostat</h2>
  <input id="username" placeholder="Username"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Σύνδεση</button>
  <p id="loginError" style="color:red"></p>
</div>

<!-- APP -->
<div id="app" class="card" style="display:none">
  <h1>Smart Thermostat</h1>

  <p>Θερμοκρασία: <span id="temp">--</span> °C</p>
  <p>Υγρασία: <span id="hum">--</span> %</p>
  <p>Θέρμανση: <span id="relay">--</span></p>

  <hr>
  <h3>Ρύθμιση θερμοκρασίας</h3>
  <input type="number" id="nTempInput" min="5" max="50">
  <button onclick="sendTemp()">Αποστολή</button>

  <p>Ρυθμισμένη: <span id="currentTemp">--</span> °C</p>

  <hr>
  <h3>Ρελέ</h3>
  <button id="btn1" class="off" onclick="toggleRelay(1)">Relay 1</button>
  <button id="btn2" class="off" onclick="toggleRelay(2)">Relay 2</button>
</div>

<script>
/* ===== LOGIN (βήμα 1–2) ===== */
const USERS = {
  admin: "1234",
  user: "1111"
};

let client = null;

function login() {
  const u = username.value;
  const p = password.value;

  if (USERS[u] && USERS[u] === p) {
    loginBox.style.display = "none";
    app.style.display = "block";
    connectMQTT();
  } else {
    loginError.innerText = "Λάθος στοιχεία";
  }
}

/* ===== MQTT (βήμα 3–4) ===== */
function connectMQTT() {
  client = mqtt.connect(
    "wss://a553b26d2ee54624914da5768a2f4839.s1.eu.hivemq.cloud:8884/mqtt",
    {
      clientId: "web_" + Math.random().toString(16).slice(2),
      username: "hivemq.webclient.1744457110038",
      password: "lG2Xjs@%50v:yDd>9EIP",
      clean: true
    }
  );

  client.on("connect", () => {
    client.subscribe([
      "esp8266/temperature",
      "esp8266/humidity",
      "esp8266/relayState",
      "esp8266/relay1State",
      "esp8266/relay2State",
      "esp8266/nTemp"
    ]);
  });

  client.on("message", onMessage);
}

function onMessage(topic, message) {
  const msg = message.toString();

  if (topic === "esp8266/temperature") temp.innerText = msg;
  if (topic === "esp8266/humidity") hum.innerText = msg;
  if (topic === "esp8266/relayState") relay.innerText = msg === "1" ? "ON" : "OFF";
  if (topic === "esp8266/relay1State") updateUI(1, msg);
  if (topic === "esp8266/relay2State") updateUI(2, msg);
  if (topic === "esp8266/nTemp") {
    currentTemp.innerText = msg;
    nTempInput.value = msg;
  }
}

function sendTemp() {
  const t = nTempInput.value;
  if (t >= 5 && t <= 50) client.publish("set/nTemp", t);
}

function toggleRelay(id) {
  const btn = document.getElementById("btn" + id);
  const state = btn.classList.contains("on") ? "0" : "1";
  client.publish("set/relay" + id, state);
}

function updateUI(id, state) {
  const btn = document.getElementById("btn" + id);
  btn.className = state === "1" ? "on" : "off";
  btn.innerText = "Relay " + id + (state === "1" ? " ON" : " OFF");
}
</script>

</body>
</html>

